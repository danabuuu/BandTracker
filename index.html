<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Band Activity Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    select option { background-color: #1e293b; color: white; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://yhchfhhdrfcotlvyoogz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloY2hmaGhkcmZjb3Rsdnlvb2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjEwNTAsImV4cCI6MjA4NDY5NzA1MH0.W5W4DA5_GdC0--WwTSVsBIKZi88xxJDKf4ri2m8gjxk';
    
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    const Icon = ({ name }) => <i className={`fas fa-${name}`}></i>;

    function BandTracker() {
      const [songs, setSongs] = useState([]);
      const [gigs, setGigs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');

      useEffect(() => { loadData(); }, []);

      const loadData = async () => {
        const { data: songsData } = await supabaseClient.from('songs').select('*').order('created_at', { ascending: false });
        const { data: gigsData } = await supabaseClient.from('gigs').select('*').order('date', { ascending: false });
        const { data: setlistData } = await supabaseClient.from('setlist_items').select('*').order('position');
        
        if (songsData) setSongs(songsData);
        if (gigsData && setlistData) {
          const gigsWithSetlists = gigsData.map(gig => ({
            ...gig,
            setlist: setlistData.filter(i => i.gig_id === gig.id).sort((a,b) => a.position - b.position).map(i => i.song_id)
          }));
          setGigs(gigsWithSetlists);
        }
        setLoading(false);
      };

      const addSong = async () => {
        const title = prompt('Song title:');
        if (!title) return;
        const { data } = await supabaseClient.from('songs').insert([{ title, artist: '', genre: '', composers: '', voicing: '', duration: '', key: '', notes: '' }]).select();
        if (data) setSongs([data[0], ...songs]);
      };

      const deleteSong = async (id) => {
        if (!confirm('Delete this song?')) return;
        await supabaseClient.from('songs').delete().eq('id', id);
        setSongs(songs.filter(s => s.id !== id));
      };

      const addGig = async () => {
        const name = prompt('Gig name:');
        if (!name) return;
        const { data } = await supabaseClient.from('gigs').insert([{ name, venue: '', date: null, time: '', notes: '' }]).select();
        if (data) setGigs([{ ...data[0], setlist: [] }, ...gigs]);
      };

      const deleteGig = async (id) => {
        if (!confirm('Delete this gig?')) return;
        await supabaseClient.from('gigs').delete().eq('id', id);
        setGigs(gigs.filter(g => g.id !== id));
      };

      const addToSetlist = async (gigId, songId) => {
        const gig = gigs.find(g => g.id === gigId);
        if (gig.setlist.includes(songId)) return;
        const newSetlist = [...gig.setlist, songId];
        await supabaseClient.from('setlist_items').insert({ gig_id: gigId, song_id: songId, position: newSetlist.length - 1 });
        setGigs(gigs.map(g => g.id === gigId ? { ...g, setlist: newSetlist } : g));
      };

      const removeFromSetlist = async (gigId, songId) => {
        await supabaseClient.from('setlist_items').delete().eq('gig_id', gigId).eq('song_id', songId);
        const gig = gigs.find(g => g.id === gigId);
        const newSetlist = gig.setlist.filter(id => id !== songId);
        if (newSetlist.length > 0) {
          await supabaseClient.from('setlist_items').delete().eq('gig_id', gigId);
          await supabaseClient.from('setlist_items').insert(newSetlist.map((sid, i) => ({ gig_id: gigId, song_id: sid, position: i })));
        }
        setGigs(gigs.map(g => g.id === gigId ? { ...g, setlist: newSetlist } : g));
      };

      const exportCSV = () => {
        const csv = Papa.unparse(songs.map(s => ({ title: s.title, artist: s.artist, genre: s.genre, composers: s.composers, voicing: s.voicing, duration: s.duration, key: s.key, notes: s.notes })));
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `repertoire_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
      };

      const handleLogin = () => {
        if (password === 'rwosings') {
          setIsUnlocked(true);
          setError('');
        } else {
          setError('Incorrect password');
        }
      };

      if (loading) return <div className="flex items-center justify-center h-screen bg-gradient-to-br from-purple-900 to-indigo-900 text-white text-2xl">Loading...</div>;

      if (!isUnlocked) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 to-indigo-900 flex items-center justify-center p-6">
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full">
              <div className="text-center mb-6">
                <Icon name="music" className="text-6xl text-white mb-4" />
                <h1 className="text-3xl font-bold text-white">Band Activity Tracker</h1>
              </div>
              <input
                type="password"
                value={password}
                onChange={e => setPassword(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && handleLogin()}
                placeholder="Enter password"
                className="w-full bg-white/20 text-white placeholder-white/50 px-4 py-3 rounded-lg mb-4"
              />
              {error && <p className="text-red-300 text-sm mb-4">{error}</p>}
              <button onClick={handleLogin} className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold px-6 py-3 rounded-lg">Unlock</button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 to-indigo-900 p-6">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden">
              <div className="bg-gradient-to-r from-purple-600 to-blue-600 p-6 flex justify-between items-center">
                <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                  <Icon name="music" /> Band Activity Tracker
                </h1>
                <button onClick={() => setIsUnlocked(false)} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                  <Icon name="lock" /> Lock
                </button>
              </div>

              <div className="p-6">
                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white">Repertoire ({songs.length} songs)</h2>
                    <div className="flex gap-2">
                      <button onClick={exportCSV} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <Icon name="download" /> Export CSV
                      </button>
                      <button onClick={addSong} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <Icon name="plus" /> Add Song
                      </button>
                    </div>
                  </div>
                  <div className="grid gap-3">
                    {songs.map(song => (
                      <div key={song.id} className="bg-white/10 p-4 rounded-lg flex justify-between items-center">
                        <div>
                          <h3 className="text-white font-bold text-lg">{song.title}</h3>
                          {song.artist && <p className="text-white/70 text-sm">{song.artist}</p>}
                          <div className="text-white/60 text-sm mt-1">
                            {song.genre && <span className="mr-3">Genre: {song.genre}</span>}
                            {song.duration && <span className="mr-3">‚è±Ô∏è {song.duration}</span>}
                            {song.key && <span>üéµ {song.key}</span>}
                          </div>
                        </div>
                        <button onClick={() => deleteSong(song.id)} className="text-red-300 hover:text-red-100">
                          <Icon name="trash" />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white">Gigs ({gigs.length})</h2>
                    <button onClick={addGig} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                      <Icon name="plus" /> Add Gig
                    </button>
                  </div>
                  <div className="grid gap-4">
                    {gigs.map(gig => (
                      <div key={gig.id} className="bg-white/10 p-4 rounded-lg">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <h3 className="text-white font-bold text-lg">{gig.name}</h3>
                            {gig.venue && <p className="text-white/70">üìç {gig.venue}</p>}
                            {gig.date && <p className="text-white/70">üìÖ {gig.date}</p>}
                          </div>
                          <button onClick={() => deleteGig(gig.id)} className="text-red-300 hover:text-red-100">
                            <Icon name="trash" />
                          </button>
                        </div>
                        <div className="border-t border-white/20 pt-3">
                          <h4 className="text-white/80 font-semibold mb-2">Setlist ({gig.setlist.length} songs)</h4>
                          {gig.setlist.map((songId, idx) => {
                            const song = songs.find(s => s.id === songId);
                            return song ? (
                              <div key={songId} className="bg-white/5 p-2 rounded mb-2 flex justify-between items-center">
                                <span className="text-white">
                                  {idx + 1}. {song.title}
                                  {song.duration && <span className="text-white/50 ml-2 text-sm">({song.duration})</span>}
                                </span>
                                <button onClick={() => removeFromSetlist(gig.id, songId)} className="text-red-300 hover:text-red-100 text-sm">
                                  <Icon name="times" />
                                </button>
                              </div>
                            ) : null;
                          })}
                          <select
                            onChange={(e) => { if (e.target.value) addToSetlist(gig.id, parseInt(e.target.value)); e.target.value = ''; }}
                            className="w-full bg-white/20 text-white px-3 py-2 rounded mt-2"
                          >
                            <option value="">+ Add song to setlist</option>
                            {songs.filter(s => !gig.setlist.includes(s.id)).map(song => (
                              <option key={song.id} value={song.id}>{song.title}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<BandTracker />, document.getElementById('root'));
  </script>
</body>
</html>
